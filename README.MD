# Klyra ERP System

Sistema ERP modular para PyMEs ecuatorianas con facturaci√≥n electr√≥nica integrada, multi‚Äëempresa y multi‚Äëbodega, con backend Django + DRF y frontend Next.js (React + TypeScript).

---

## üìã Tabla de Contenidos
- [Descripci√≥n](#descripci√≥n)
- [Arquitectura](#arquitectura)
- [Tecnolog√≠as](#tecnolog√≠as)
- [Estructura del Proyecto](#estructura-del-proyecto)
- [Mapa de Apps y Estado Actual](#mapa-de-apps-y-estado-actual)
- [Modelos Clave por App](#modelos-clave-por-app)
- [APIs y Endpoints Activos](#apis-y-endpoints-activos)
  - [Autenticaci√≥n JWT](#autenticaci√≥n-jwt)
  - [Documentaci√≥n OpenAPI](#documentaci√≥n-openapi)
  - [M√≥dulo Base](#m√≥dulo-base)
  - [M√≥dulo Inventario](#m√≥dulo-inventario)
  - [M√≥dulo Ventas](#m√≥dulo-ventas)
  - [M√≥dulo RRHH](#m√≥dulo-rrhh)
- [Multitenancy y Contexto de Empresa](#multitenancy-y-contexto-de-empresa)
- [Frontend (Next.js)](#frontend-nextjs)
- [Configuraci√≥n y Entornos](#configuraci√≥n-y-entornos)
- [Instalaci√≥n y Puesta en Marcha](#instalaci√≥n-y-puesta-en-marcha)
- [Despliegue](#despliegue)
- [Pruebas](#pruebas)
- [Registro y Monitoreo](#registro-y-monitoreo)
- [Roadmap](#roadmap)
- [Contribuir](#contribuir)
- [Licencia](#licencia)
- [Contacto](#contacto)

---

## üìñ Descripci√≥n
Klyra ERP es un sistema modular orientado a operaciones empresariales en Ecuador: inventario, ventas, compras, finanzas, RRHH y facturaci√≥n electr√≥nica SRI. Provee una API REST completa, interfaz moderna y un modelo de seguridad basado en permisos de Django.

Beneficios clave:
- Cumplimiento con normativa ecuatoriana (SRI) y base para facturaci√≥n electr√≥nica
- Multi‚Äëempresa, multi‚Äëbodega y trazabilidad de stock
- Interfaz moderna y responsive (Next.js + Tailwind)
- Documentaci√≥n de API generada autom√°ticamente (OpenAPI/Swagger)

---

## üèóÔ∏è Arquitectura
- Monorepo con backend en Django/DRF y frontend en Next.js.
- Comunicaci√≥n v√≠a API REST (`/api/...`) protegida con JWT (access/refresh).
- Contexto multi‚Äëempresa mediante middleware a nivel de request.
- Documentaci√≥n de API con `drf-spectacular` y UI Swagger en `/api/docs/`.
- PostgreSQL como base de datos relacional.

Diagrama alto nivel:
```
[Frontend (Next.js)]  ‚Üí  [API DRF: /api/*]
                             ‚îÇ
                             ‚îú‚îÄ‚îÄ apps.base, apps.inventario, apps.ventas, apps.compras,
                             ‚îÇ   apps.finanzas, apps.rrhh, apps.facturacion
                             ‚îÇ
                        [Servicios / Managers / Utils]
                             ‚îÇ
                         [PostgreSQL Database]
```

---

## üõ†Ô∏è Tecnolog√≠as
- Backend: Python 3.11+, Django 5.x, Django REST Framework, drf‚Äëspectacular, SimpleJWT, CORS Headers
- DB: PostgreSQL 14+
- Frontend: Next.js 16, React 19, TypeScript, TailwindCSS 4, Radix UI, SWR
- Dev: Docker Compose (opcional), dotenv, python‚Äëdecouple, cities_light

---

## üóÇÔ∏è Estructura del Proyecto
Ruta ra√≠z: `C:\PycharmProjects\Klyra`

```
Klyra/                      # Proyecto Django (settings, urls)
apis/                       # API REST (ViewSets/routers por m√≥dulo)
apps/                       # Apps de dominio (models, migrations)
frontend/                   # Next.js (App Router)
middleware/                 # Middlewares (TenantMiddleware)
managers/, utils/, shared/  # Utilidades y helpers comunes
templates/, static/, media/ # Plantillas, est√°ticos, uploads
requirements/               # Requerimientos Python por entorno
logs/                       # Archivos de log (p.ej. facturacion_electronica.log)
manage.py                   # CLI Django
```

---

## üß≠ Mapa de Apps y Estado Actual
Origen: `Klyra/settings/base.py`

- Django core y terceros (ACTIVO):
  - `django.contrib.*`, `rest_framework`, `rest_framework_simplejwt`, `corsheaders`, `cities_light`
- Apps de dominio (ACTIVO si listada abajo):
  - `apps.base` (ACTIVO)
  - `apps.compras` (ACTIVO)
  - `apps.finanzas` (ACTIVO)
  - `apps.inventario` (ACTIVO)
  - `apps.rrhh` (ACTIVO)
  - `apps.ventas` (ACTIVO)
  - `apps.facturacion` (ACTIVO)

Middlewares relevantes (ACTIVO): `middleware.tenant_middleware.TenantMiddleware`

---

## üìò Modelos Clave por App
A continuaci√≥n, un resumen de modelos principales. El detalle completo se encuentra en los archivos de cada app.

- apps.base
  - Modelos base y utilitarios compartidos (p. ej., `BaseModel`, timestamps, `is_active`).

- apps.rrhh
  - `Empleado` (relaci√≥n con `Empresa`, utilizada por el middleware para determinar `request.empresa`).

- apps.inventario (archivo: `apps/inventario/models.py`)
  - `Categoria`
    - Jer√°rquica (`categoria_padre`, `nivel` calculado)
    - `codigo` autogenerado (prefijo + correlativo de 2 d√≠gitos, p. ej., `MOT-01`)
    - Permisos espec√≠ficos (p. ej., `ver_jerarquia_categorias`)
  - `Marca`
  - `UnidadMedida` y `UnidadConversion`
  - `Producto`
  - `Bodega`, `Stock`, `TransferenciaBodega`
  - `MovimientoInventario`, `DetalleMovimiento`

- apps.ventas
  - Entidades de ventas: `Cliente`, `Venta`, `Pago` (expuestas v√≠a API, ver Endpoints).

- apps.compras, apps.finanzas, apps.facturacion
  - Estructura presente; detalle funcional en evoluci√≥n. `apps.facturacion` integra con SRI (logs en `logs/facturacion_electronica.log`).

Nota: los modelos de Inventario est√°n optimizados con `select_related`/`prefetch_related` a nivel de vistas para evitar N+1.

---

## üåê APIs y Endpoints Activos
Enrutamiento global: `Klyra/urls.py` incluye las URLs de `apis.base`, `apis.seguridad`, `apis.ventas`, `apis.inventario` bajo la ra√≠z; cada m√≥dulo expone sus rutas bajo `/api/`.

Base URL de API en desarrollo: `http://localhost:8000/api/`

### Autenticaci√≥n JWT
- `POST /api/auth/login/` ‚Üí obtiene tokens de acceso y refresco
- `POST /api/auth/refresh/` ‚Üí renueva token de acceso

Ejemplo (login):
```bash
curl -X POST http://localhost:8000/api/auth/login/ \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"<tu_pass>"}'
```

### Documentaci√≥n OpenAPI
- Esquema: `GET /api/schema/`
- Swagger UI: `GET /api/docs/`

### M√≥dulo Base
Archivo: `apis/base/urls.py` (ACTIVO)
- `POST /api/enviaremail/` ‚Äî Env√≠o de correo (ViewSet `EnvioEmail`)
- `GET  /api/user/me/` ‚Äî Usuario autenticado actual

### M√≥dulo Inventario
Archivo: `apis/inventario/urls.py` (ACTIVO)

Recursos expuestos v√≠a `DefaultRouter` (CRUD completo por `ModelViewSet`, salvo restricciones de permisos):
- `GET /api/productos/` ‚Äî Listar
- `POST /api/productos/` ‚Äî Crear
- `GET /api/productos/{id}/` ‚Äî Detalle
- `PUT/PATCH /api/productos/{id}/` ‚Äî Actualizar
- `DELETE /api/productos/{id}/` ‚Äî Eliminar

- `GET /api/categorias/` ‚Äî Listar (filtros soportados: `nivel`, `padre`, `search`)
- `POST /api/categorias/`
- `GET /api/categorias/{id}/`
- `PUT/PATCH /api/categorias/{id}/`
- `DELETE /api/categorias/{id}/`

- `GET /api/marcas/`, `POST /api/marcas/`, `GET/PUT/PATCH/DELETE /api/marcas/{id}/`
- `GET /api/unidades-medida/`, `POST /api/unidades-medida/`, `GET/PUT/PATCH/DELETE /api/unidades-medida/{id}/`
- `GET /api/movimientos-inventario/`, `POST /api/movimientos-inventario/`, `GET/PUT/PATCH/DELETE /api/movimientos-inventario/{id}/`
- `GET /api/bodegas/`, `POST /api/bodegas/`, `GET/PUT/PATCH/DELETE /api/bodegas/{id}/`

Detalles relevantes ‚Äî `CategoriaViewSet` (`apis/inventario/categoria/categoria_viewset.py`):
- Permisos: `IsAuthenticated` + verificaci√≥n de permisos por acci√≥n (`view/add/change/delete`)
- Optimizaci√≥n: `select_related('categoria_padre')` y `prefetch_related('subcategorias' ... hasta 6 niveles)`
- Ordenaci√≥n por `nivel`, `nombre`, `id`
- Filtros de query:
  - `nivel`: entero (1, 2, 3, ...)
  - `padre`: id de categor√≠a padre (vac√≠o para ra√≠z)
  - `search`: por `codigo`, `nombre`, `descripcion`

### M√≥dulo Ventas
Archivo: `apis/ventas/urls.py` (ACTIVO)
- `GET/POST /api/clientes/` y `GET/PUT/PATCH/DELETE /api/clientes/{id}/`
- `GET/POST /api/productos/` y `GET/PUT/PATCH/DELETE /api/productos/{id}/` (expuesto aqu√≠ para consultas desde ventas)
- `GET/POST /api/ventas/` y `GET/PUT/PATCH/DELETE /api/ventas/{id}/`
- `GET/POST /api/pagos/` y `GET/PUT/PATCH/DELETE /api/pagos/{id}/`

### M√≥dulo RRHH
Archivo: `apis/rrhh/urls.py` (ACTIVO)
- `GET/POST /api/empleados/` y `GET/PUT/PATCH/DELETE /api/empleados/{id}/`

Notas de estado:
- Todos los routers anteriores est√°n INCLUIDOS en `Klyra/urls.py` ‚Üí ENDPOINTS ACTIVOS.
- Autenticaci√≥n JWT y documentaci√≥n OpenAPI est√°n ACTIVAS.

---

## üè¢ Multitenancy y Contexto de Empresa
Archivo: `middleware/tenant_middleware.py` (ACTIVO)
- `TenantMiddleware` adjunta `request.empresa` si el usuario autenticado posee `empleado.empresa`.
- Helpers thread‚Äëlocal: `get_current_empresa()`, `set_current_empresa()`, `clear_current_empresa()`.
- Limpieza del contexto al finalizar cada request o ante excepciones.

Impacto: facilita la segregaci√≥n de datos por empresa y su uso en managers/queries/permissions.

---

## ‚öõÔ∏è Frontend (Next.js)
- Next.js 16 (App Router) + React 19 + TypeScript
- TailwindCSS 4 + Radix UI + SWR + React Hook Form

Rutas y m√≥dulos destacados:
- `frontend/app/(dashboard)/inventario/categorias/[id]/page.tsx`
- `frontend/app/(dashboard)/inventario/categorias/[id]/editar/page.tsx`
- Componentes: `categorias-section.tsx`, `bodegas-section.tsx`, `productos-section.tsx`
- Formularios: `activar-cuenta-form.tsx`, `producto-form.tsx`
- Componente compartido: `src/shared/components/header.tsx`

---

## ‚öôÔ∏è Configuraci√≥n y Entornos
Variables de entorno (via `python-decouple` y `.env`):
- `SECRET_KEY`
- `DEBUG` (true/false)
- `ALLOWED_HOSTS` (coma‚Äëseparado)
- CORS: or√≠genes permitidos (`http://localhost:3000`, `http://192.168.1.100:3000` por defecto)
- DB: configuraci√≥n PostgreSQL (usar settings por entorno)

Archivos relevantes:
- `Klyra/settings/base.py`
- `requirements/` (dependencias por entorno)
- `docker-compose.yml` (si se usa)

---

## üöÄ Instalaci√≥n y Puesta en Marcha
Backend:
1) Crear y activar entorno virtual (Windows)
```bash
python -m venv .venv
.\.venv\Scripts\activate
```
2) Instalar dependencias
```bash
pip install -r requirements/base.txt
```
3) Configurar `.env`
```bash
SECRET_KEY=...
DEBUG=true
ALLOWED_HOSTS=localhost,127.0.0.1,192.168.1.100
```
4) Migraciones + superusuario
```bash
python manage.py migrate
python manage.py createsuperuser
```
5) Carga opcional de cat√°logos
```bash
python manage.py cities_light
# python manage.py setup_inventario_roles   # si existe
```
6) Ejecutar servidor
```bash
python manage.py runserver 0.0.0.0:8000
```

Frontend:
```bash
cd frontend
npm install
npm run dev
```

---

## üì¶ Despliegue
- `DEBUG=false`, `ALLOWED_HOSTS` definido
- Servir est√°ticos con `collectstatic` y Nginx
- WSGI/ASGI server (gunicorn/uvicorn workers)
- DB PostgreSQL gestionada, backups, HTTPS

---

## ‚úÖ Pruebas
```bash
python manage.py test
```
- Tests unitarios por app y tests de API con DRF.

---

## üßæ Registro y Monitoreo
- Logs en `logs/` (ej.: `logs/facturacion_electronica.log`).
- Configurar niveles de logging por entorno y rotaci√≥n.

---

## üó∫Ô∏è Roadmap
- [ ] Completar reglas de negocio avanzadas en Inventario
- [ ] Flujos de compras/ventas con aprobaciones
- [ ] Contabilidad (asientos autom√°ticos y reportes)
- [ ] Integraci√≥n SRI (emisi√≥n/recepci√≥n) end‚Äëto‚Äëend
- [ ] Auditor√≠a y bit√°coras
- [ ] i18n

---

## ü§ù Contribuir
- Issues/PRs con descripci√≥n clara, pasos y evidencias.
- Estilo PEP8 y convenciones del proyecto.

---

## üìÑ Licencia
Pendiente (propietaria o MIT). Agregar `LICENSE` cuando se decida.

---

## üì¨ Contacto
- Equipo Klyra
- Soporte: soporte@klyra.local
- API Docs: `http://localhost:8000/api/docs/`
